# 更新日志

本文档记录了 Policy Crawler Pro 项目的所有版本更新。

## [3.1.3] - 2025-12-26

### ✨ 新功能
- **多数据源支持增强**：
  - 集成广东省法规数据源（GD），支持地方性法规、政府规章、规范性文件爬取
  - 实现GD数据源的完整爬取流程，包括政策列表获取、详情获取和附件下载
  - 支持GD数据源的动态配置和验证

- **智能正文提取**：
  - 当API返回的正文内容为空时，自动从附件文件中提取正文
  - 支持DOCX、DOC、PDF格式附件的自动下载和转换
  - 智能文件扩展名识别，确保准确匹配文件类型

- **快代理（KDL）集成优化**：
  - 支持独立的SecretId和SecretKey配置
  - 添加KDL连接测试功能，方便验证代理配置
  - 实现代理配置的动态更新，无需重启应用

### 🔧 系统优化
- **数据源验证逻辑优化**：
  - 区分MNR和GD数据源的必填字段验证
  - GD数据源支持`type`、`api_base_url`、`law_rule_types`配置
  - 改进数据源选择逻辑，确保正确过滤和显示

- **前端界面改进**：
  - 修复数据源选择显示问题，"已选择"标签准确反映用户选择
  - 优化KDL配置界面，提供独立的SecretId和SecretKey输入框
  - 添加KDL连接测试按钮，提供实时配置验证

- **代码质量提升**：
  - 改进错误处理和日志记录
  - 优化代码格式和可读性
  - 增强类型安全和错误提示

### 🐛 Bug修复
- 修复GD数据源爬取时`detail_result`未定义错误
- 修复数据源选择逻辑，确保只爬取用户选择的数据源
- 修复前端数据源显示问题，"政府信息公开平台"不再错误显示为已启用
- 修复GD数据源正文获取问题，当API返回空内容时自动从附件提取

### 📝 项目重命名
- 项目名称从"MNR Law Crawler Online"更名为"Policy Crawler Pro"（政策爬虫专业版）
- 更新所有相关文档和代码注释

## [3.1.2] - 2025-12-24

### 🔧 代码质量改进
- **类型安全增强**：
  - 改进 TaskCreationForm.vue 中的类型定义，移除 `any` 类型使用
  - 在 Tasks.vue 中添加类型守卫函数，确保类型安全
  - 改进 ScheduledTasks.vue 中的类型定义，使用明确的类型而非 `any`
  - 优化 Policies.vue 中的类型处理

- **错误处理优化**：
  - 移除未使用的 error 变量，改进错误处理逻辑
  - 在多个组件中统一错误处理方式
  - 改进错误捕获和日志记录

- **代码格式改进**：
  - 格式化后端 API 代码（scheduled_tasks.py）
  - 改进代码可读性和一致性
  - 统一代码风格

### 🐛 Bug修复
- 修复 Tasks.vue 中定时任务类型检查逻辑，防止在错误页面创建定时任务
- 改进 TaskCreationForm.vue 中的类型转换，避免类型错误

## [3.1.1] - 2025-12-23

### 🐛 Bug修复
- 修复 Dockerfile 中 apt-get 命令的非交互模式设置，提高构建可靠性
- 修复 Tasks.vue 中的错误处理，在进度流传输期间忽略解析错误，增强任务管理的健壮性

### 📝 文档更新
- 移除过时的数据流文档和 Mermaid 可视化图表
- 更新 README.md 以反映文件移除，简化项目结构

### 🛠️ 技术改进
- 优化 Dockerfile 构建流程
- 改进前端错误处理逻辑

## [3.1.0] - 2025-12-14

### ✨ 新功能
- **详细进度跟踪系统**：实现基于 SSE 的实时进度流传输功能
  - 广播任务执行阶段的实时更新
  - 显示整体进度和各个阶段的详细信息
  - 显示成功率和处理状态
  - 提升长时间运行任务的用户体验和反馈

### 🔧 系统优化
- 重构调度器服务，支持基于配置更改动态启用和禁用定时任务
- 改进前端进度显示，提供更全面的进度信息

## [3.0.3] - 2025-12-13

### ✨ 新功能
- **备份文件上传**：实现备份文件上传功能
  - 添加备份上传 API 端点
  - 支持 .sql 文件验证
  - 增强 BackupService 以从上传文件创建备份记录
  - 更新前端组件支持文件选择和上传

- **附件批量下载和内容合并**：
  - 添加批量下载附件的 API 端点
  - 实现将附件内容合并到政策文本的功能
  - 增强前端 UI，支持下载所有附件和显示处理信息
  - 改进附件操作的错误处理和用户反馈

### 🔧 系统优化
- 重构任务管理 UI 组件，使用统一的 TaskCreationForm 创建和编辑任务
- 简化任务创建逻辑，整合表单处理和验证
- 更新邮件通知逻辑，改进错误处理和日志记录
- 增强文件下载过程，改进文件路径管理和存在性检查
- 添加邮件服务配置重载功能，当 "email_enabled" 标志切换时通知邮件服务重新加载配置

### 🐛 Bug修复
- 修复任务管理错误处理，简化 HTTPException 抛出
- 更新 Policies.vue 和 PolicyDetail.vue 以增强 UI 一致性和可读性
- 改进数据源处理，提高政策详情中的清晰度
- 修复 TaskCreationForm 验证逻辑，使用表单值直接进行数据源选择
- 简化未选择数据源的警告消息

### 🧹 代码清理
- 移除未使用的依赖检查脚本和类型检查工具
- 移除过时的数据库修复脚本和示例数据文件
- 清理未使用的 SQL 索引修复和与数据库维护相关的 Python 脚本
- 更新前端 API 和组件文件以改进数据处理和 UI 一致性

## [3.0.2] - 2025-12-12

### 🔧 系统优化
- **数据库连接优化**：
  - 优化数据库连接设置以减少内存使用并提高性能
  - 使用更快的压缩算法和进度日志记录增强任务文件下载过程
  - 实现内存清理和使用日志记录

- **日期时间处理改进**：
  - 更新多个服务以使用时区感知的 datetime 对象
  - 确保在 UTC 中一致的时间表示
  - 增强日志记录、备份和任务管理中的时间戳准确性

- **配置服务优化**：
  - 重构 ConfigService 以改进 JSON 值处理
  - 添加 `_parse_json_value` 和 `_serialize_value` 方法
  - 简化地址解析逻辑以提高可读性

- **代码质量提升**：
  - 重构全局变量使用，移除不必要的锁
  - 改进代码格式检查和错误消息
  - 增强后端服务模块导出列表
  - 更新 ESLint 配置以忽略 Vue 自动生成的类型定义文件

### 🧹 代码清理
- 重构 generate_env.py 和 check_types.py 以提高可读性和一致性
- 更新字符串格式并移除不必要的空行
- 改进类型检查方法，使用更清晰的函数签名

### 🛠️ CI/CD 改进
- 增强 CI 工作流，添加自定义类型检查步骤
- 改进依赖验证，使用包名到导入名的映射
- 改进重定向测试和端点测试
- 更新 Docker Compose 配置以改进服务连接和测试

## [3.0.1] - 2025-12-10 至 2025-12-11

### 🐳 Docker 优化
- **数据库容器优化**：
  - 增强 docker-entrypoint-wrapper.sh 以改进随机字符串生成
  - 添加多种备用方法（Python、/dev/urandom、OpenSSL）
  - 改进数据目录验证和清理逻辑
  - 增强数据库健康检查参数和初始化等待时间
  - 在 Dockerfile 中显式创建 PostgreSQL 数据目录

- **后端容器优化**：
  - 重构 Dockerfile 以改进 Python 安装过程
  - 增强错误处理和重试逻辑
  - 简化包更新和安装命令以提高跨平台兼容性

- **网络配置优化**：
  - 更新 docker-compose.yml 以限制外部端口暴露
  - 配置网络设置，包括指定子网以避免冲突
  - 启用可附加网络以支持外部容器访问
  - 修改 API 基础 URL 处理以支持生产环境和开发环境

### 🔧 系统改进
- **数据库表创建逻辑**：
  - 增强数据库表创建逻辑以检查现有表，避免重复错误
  - 改进日志记录，优雅处理用户创建错误
  - 允许非关键问题的警告，同时保持应用程序启动完整性

- **前端改进**：
  - 重构 TypeScript 类型以改进组件处理
  - 增强 main.ts 中 Element Plus 组件的类型安全性
  - 更新 Axios 错误处理
  - 改进 policies.ts 中的类型定义
  - 清理任务显示逻辑以提高可读性和可维护性

### 🛠️ CI/CD 改进
- **GitHub Actions 工作流**：
  - 增强 CI 工作流以支持基于目标规范的 Docker 镜像构建
  - 添加 Docker 镜像扫描（后端和前端服务）
  - 改进健康检查、数据库迁移步骤和集成测试
  - 添加服务就绪等待机制
  - 更新 Trivy 扫描输出并改进日志记录
  - 改进重定向测试和端点测试
  - 添加 API 登录端点测试
  - 使用 Docker Compose V2 以提高兼容性和性能

- **安全扫描**：
  - 更新 Trivy action 版本以改进漏洞扫描兼容性
  - 改进安全扫描摘要输出以提高清晰度
  - 增强 CI 工作流权限以改进安全事件处理

### 📝 文档更新
- 更新 README.md 以包含重要的 Docker 部署说明
- 添加 GitHub Actions 部署详细信息
- 移除过时的 .github/README.md 文件
- 更新版本日期和部署信息

### 🐛 Bug修复
- 修复数据库初始化问题
- 修复密码生成错误处理
- 修复网络连接和健康检查问题
- 修复前端 API 基础 URL 处理

---

## [3.0.0] - 2025-12-09

### 🎉 Docker 优化与自动化
- ✨ **自动生成随机密钥**：容器启动时自动生成数据库密码和JWT密钥，无需手动配置
- 🔒 **密码持久化机制**：密码保存在数据卷中，容器重启不会覆盖
- 🚀 **多阶段构建优化**：减小镜像体积30-40%，提升构建速度40-60%
- 🔐 **安全增强**：非root用户运行，网络隔离，资源限制
- 📊 **日志管理**：自动日志轮转，防止日志文件过大
- ⚡ **健康检查优化**：改进的健康检查配置，确保服务可用性
- 🌐 **国内镜像源支持**：自动配置清华大学镜像源，加速包下载（apt、apk、npm、pip）
- 🔄 **网络重试机制**：添加超时和重试配置，提高网络稳定性

### 🛠️ 技术改进
- 📦 **后端Dockerfile优化**：多阶段构建，依赖缓存优化，非root用户，系统级包安装
- 🌐 **前端Dockerfile优化**：Nginx 1.28配置优化，静态资源缓存，Gzip压缩，非root用户运行
- 🗄️ **数据库Dockerfile优化**：移除中文分词依赖，简化配置，减小镜像体积
- 📝 **环境变量管理**：支持`.env`文件，提供自动生成脚本
- 🔧 **Entrypoint脚本优化**：修复Windows CRLF换行符问题，改进密码读取逻辑

### 📋 新增文件
- `generate-env.ps1` - Windows环境变量生成脚本
- `generate_env.py` - 跨平台环境变量生成脚本
- `env.example` - 环境变量配置示例
- `database/docker-entrypoint-wrapper.sh` - 数据库密码自动生成脚本
- `database/save-password.sh` - 数据库密码持久化脚本
- `backend/docker-entrypoint.sh` - 后端密钥自动生成脚本

### 🐛 Bug修复
- 🔧 **修复Nginx配置错误**：移除重复的`keepalive_timeout`和`pid`指令
- 🔧 **修复权限问题**：修复Nginx非root用户运行时的PID文件权限问题
- 🔧 **修复后端uvicorn模块找不到**：改为系统级安装Python包，确保所有用户可访问
- 🔧 **修复数据库初始化问题**：改进数据目录清理逻辑，避免初始化冲突

---

## 版本历史

- **v3.1.3** (2025-12-26) - 多数据源支持增强与项目重命名
- **v3.1.2** (2025-12-24) - 代码质量改进
- **v3.1.1** (2025-12-23) - 文档清理和最终优化
- **v3.1.0** (2025-12-14) - 任务管理和进度跟踪系统
- **v3.0.3** (2025-12-13) - 备份上传和附件批量下载
- **v3.0.2** (2025-12-12) - 系统优化和重构
- **v3.0.1** (2025-12-10 至 2025-12-11) - Docker 和 CI/CD 优化
- **v3.0.0** (2025-12-09) - Docker优化与自动配置

